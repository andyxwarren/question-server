<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maths Arcade</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #111;
            color: #0f0;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }

        .welcome-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #0f0;
            box-shadow: 0 0 12px rgba(0, 255, 0, 0.8);
            color: #0f0;
            padding: 12px 20px;
            border-radius: 999px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.55em;
            letter-spacing: 1px;
            z-index: 1200;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .welcome-toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        .container {
            border: 5px solid #0f0;
            padding: 10px;
            background-color: #222;
            box-shadow: 0 0 20px #0f0, 0 0 30px #0f0 inset;
            width: 95%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
        }

        .page {
            display: none;
            height: 100%;
            flex-direction: column;
            align-items: center;
        }

        .page.active {
            display: flex;
        }

        /* --- Header / Breadcrumbs --- */
        .breadcrumb-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: nowrap;
            height: 50px;
            width: 100%;
            padding: 0 5px;
            margin-bottom: 10px;
            border-bottom: 3px solid #0f0;
            flex-shrink: 0;
        }

        .breadcrumb-button {
            padding: 8px 12px;
            background-color: #ff9800;
            color: #111;
            border: 3px solid #000;
            border-radius: 6px;
            font-family: 'Press Start 2P', cursive;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 4px 0 #c66900;
            transition: all 0.1s;
            font-size: 0.6em;
            margin-right: 5px;
        }
        .breadcrumb-button:hover { background-color: #f57c00; }
        .breadcrumb-button:active { transform: translateY(3px); box-shadow: 0 1px 0 #c66900; }
        
        .breadcrumb-separator {
            font-size: 1em;
            color: #0ff;
            margin: 0 5px;
        }

        /* --- Titles --- */
        .title-area {
            flex-shrink: 0;
            margin-bottom: 15px;
            width: 100%;
        }

        .title {
            color: #ff00ff;
            text-shadow: 0 0 5px #ff00ff;
            margin: 5px 0;
            font-size: 1.2em;
            line-height: 1.2;
        }

        .subtitle {
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
            margin: 5px 0 10px 0;
            font-size: 0.7em;
            min-height: 1em;
        }

        .welcome-message {
            color: #f0f;
            text-shadow: 0 0 10px #f0f, 0 0 20px #f0f;
            width: 100%;
            text-align: center;
            font-size: 1.6em;
            line-height: 1.5;
            margin-top: 5px;
        }

        /* --- Grid & Buttons --- */
        .arcade-button-container {
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 20px;
            justify-content: center;
            align-content: center;
            flex-grow: 1;
            width: fit-content;
            margin: 0 auto;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .arcade-button-container::-webkit-scrollbar { display: none; }

        .arcade-button {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.55em;
            cursor: pointer;
            border-radius: 50%;
            position: relative;
            width: 115px;
            height: 115px;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            padding: 2px;
            background: none;
            box-shadow: 0 6px 0 #222, 0 10px 20px #333a;
            border: none;
            margin: 0;
        }

        .arcade-button::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            z-index: 1;
            background: radial-gradient(circle at 60% 35%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.10) 100%),
                var(--arcade-btn-color, #ffd600);
            border: 6px solid var(--arcade-btn-color, #ffd600);
            box-shadow: 0 3px 10px #000b inset, 0 0 0 6px rgba(0,0,0,0.12);
        }

        .arcade-button span {
            position: relative;
            z-index: 3;
            display: block;
            width: 92%;
            line-height: 1.2;
            color: #111;
            white-space: normal;
            word-break: break-word;
            text-align: center;
        }

        /* Helper class for buttons with slightly longer words */
        .arcade-button span.long-text {
            font-size: 0.85em; 
        }

        /* Helper class for buttons with VERY long words (e.g. Equivalence, Combinations) */
        .arcade-button span.compact-text {
            font-size: 0.75em; /* Relative to parent button font-size */
        }

        .arcade-button::after {
            content: '';
            position: absolute;
            z-index: 2;
            top: 10px;
            left: 25%;
            width: 50%;
            height: 12px;
            background: linear-gradient(90deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0) 100%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.7;
        }

        .arcade-button:active:not(.blank) {
            box-shadow: 0 3px #222, 0 5px 10px #333a;
            transform: translateY(3px);
        }

        /* --- Specific Sizing for FDP Page to fit 12 buttons --- */
        #worldFDPPage .arcade-button-container {
            gap: 10px; 
        }
        #worldFDPPage .arcade-button {
            width: 95px; 
            height: 95px;
            font-size: 0.45em; /* Smaller base size for this page */
        }
        /* Even smaller text for the long words on the small FDP buttons */
        #worldFDPPage .arcade-button span.compact-text {
            font-size: 0.65em; 
        }

        /* --- Blank Button Styling --- */
        /* Updated: No longer greyscale. They look normal but do nothing. */
        .arcade-button.blank {
            cursor: default;
            pointer-events: none;
            /* Optional: slight inner shadow to suggest 'no press' without losing color? 
               Removed for now to keep them identical in look as requested */
        }

        /* Responsive Adjustments */
        @media (max-height: 600px) {
            .arcade-button { width: 90px; height: 90px; font-size: 0.45em; }
            .container { padding: 5px; }
            .welcome-message { font-size: 1.2em; }
            .arcade-button-container { gap: 10px; }
        }
        
        /* Mobile view adjustments */
        @media (max-width: 480px) {
            body {
                overflow: hidden; /* No body scroll - container handles it */
                height: 100vh;
            }
            
            /* Container is FIXED with green border - doesn't scroll */
            body .container {
                position: fixed;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                width: min(calc(100vw - 20px), 420px); /* perfect centering within viewport */
                bottom: 5px;
                height: auto;
                overflow: hidden;
                padding: 10px;
                padding-top: 10px;
                z-index: 10;
                box-sizing: border-box;
            }
            
            /* Breadcrumb container - holds title, uses flexbox for perfect centering */
            .breadcrumb-container {
                display: flex !important;
                align-items: center; /* Vertical centering */
                justify-content: center; /* Horizontal centering */
                height: 45px; /* Fixed height */
                margin: -5px 5px 0 5px; /* Restore original green line position */
                padding: 0;
                border-bottom: 3px solid #0f0;
                box-shadow: 0 0 8px #0f0;
            }
            
            /* PowerUp Academy title - same style as Choose World with glow */
            .welcome-message {
                font-size: 0.9em;
                line-height: 1;
                margin: 0;
                padding: 0;
                text-align: center;
                color: #ff00ff;
                text-shadow: 0 0 5px #ff00ff; /* Same glow as .title */
                background: transparent;
                font-weight: bold !important;
            }
            
            /* Hamburger menu - inside green border, doesn't extend beyond green line */
            #userHeaderContainer {
                position: fixed !important;
                top: 15px !important;
                right: 30px !important;
                z-index: 1000 !important;
            }
            
            /* Title area below the green line - minimal gap */
            .title-area {
                margin-bottom: 0;
                margin-top: 10px; /* Restore visual cushion below green line */
                padding-bottom: 0;
            }
            
            .title {
                font-size: 0.85em;
                margin: 0;
            }
            
            .subtitle {
                font-size: 0.55em;
                margin: 3px 0;
            }
            
            .breadcrumb-button {
                font-size: 0.5em;
                padding: 6px 10px;
                margin-top: -6px; /* lift button to align with hamburger without moving green line */
            }
            
            /* 2 buttons per row on mobile - BIGGER buttons with BIGGER text */
            .arcade-button-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr);
                place-items: center;
                row-gap: 24px;
                column-gap: 26px;
                padding: 110px 24px 10px; /* internal offset keeps buttons below header */
                width: 100%;
                max-width: 100%;
                margin: -94px auto 10px; /* overlap upward so only a thin strip is visible */
                box-sizing: border-box;
                overflow-y: auto; /* Buttons scroll inside container */
                overflow-x: hidden;
                max-height: calc(100% + 10px); /* compensate for the large padding-top */
            }
            
            .arcade-button {
                width: 130px;
                height: 130px;
                font-size: 0.65em; /* Increased from 0.5em for larger text */
                margin: 0;
            }
            
            .arcade-button span {
                font-size: 1em; /* Ensure text inside button is readable */
                line-height: 1.2;
            }
            
            /* FDP world buttons should match standard sizing on mobile */
            #worldFDPPage .arcade-button {
                width: 130px !important;
                height: 130px !important;
                font-size: 0.65em !important;
            }
            
            #worldFDPPage .arcade-button-container {
                row-gap: 24px !important;
                column-gap: 26px !important;
            }
            
            .page {
                overflow: hidden;
                height: 100%;
                flex-direction: column;
                /* display is controlled by .active class - don't override here */
            }
            
            .page.active {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="userHeaderContainer" style="position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>
    <div id="welcomeToast" class="welcome-toast"></div>
    
    <div class="container">
        
        <!-- ========================================= -->
        <!-- MAIN PAGE: THE 9 WORLDS (STRANDS)         -->
        <!-- ========================================= -->
        <div id="worldsPage" class="page active">
            <div class="breadcrumb-container"></div>
            
            <div class="title-area">
                <h1 class="title">SELECT A WORLD</h1>
                <h2 class="subtitle">&nbsp;</h2>
            </div>
            
            <div class="arcade-button-container">
                <button class="arcade-button nav-btn" onclick="showPage('worldNumberPage')">
                    <span>Number &<br>Place Value</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldCalculationsPage')">
                    <span class="long-text">Calculations<br>(+ - x รท)</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldFDPPage')">
                    <span>Fractions<br>Decimals<br>%</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldRatioPage')">
                    <span>Ratio &<br>Proportion</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldAlgebraPage')">
                    <span>Algebra</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldMeasurementPage')">
                    <span class="long-text">Measurement</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldShapesPage')">
                    <span class="long-text">Properties<br>of Shapes</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldPositionPage')">
                    <span>Position &<br>Direction</span>
                </button>
                <button class="arcade-button nav-btn" onclick="showPage('worldStatisticsPage')">
                    <span class="long-text">Statistics</span>
                </button>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- SUB-PAGES: MISSIONS (SUBSTRANDS)          -->
        <!-- ========================================= -->

        <!-- 1. Number & Place Value (6 Buttons - 2 Rows) -->
        <div id="worldNumberPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">NUMBER & PLACE VALUE</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="N1" data-mission="Counting"><span>Counting</span></button>
                <button class="arcade-button mission-btn" data-cdr="N2" data-mission="Read, Write, Order & Compare"><span>Read, Write,<br>Order &<br>Compare</span></button>
                <button class="arcade-button mission-btn" data-cdr="N3" data-mission="Place Value & Roman Numerals"><span>Place Value<br>& Roman<br>Numerals</span></button>
                <button class="arcade-button mission-btn" data-cdr="N4" data-mission="Identify, Represent, Estimate & Round"><span class="compact-text">Identify,<br>Represent,<br>Estimate<br>& Round</span></button>
                <button class="arcade-button mission-btn" data-cdr="N5" data-mission="Negative Numbers"><span>Negative<br>Numbers</span></button>
                <button class="arcade-button mission-btn" data-cdr="N6" data-mission="Number Problems"><span>Number<br>Problems</span></button>
            </div>
        </div>

        <!-- 2. Calculations (9 Buttons - 3 Rows) -->
        <div id="worldCalculationsPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">CALCULATIONS</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="C1" data-mission="Add & Subtract Mentally"><span>Add & Subtract<br>Mentally</span></button>
                <button class="arcade-button mission-btn" data-cdr="C2" data-mission="Add & Subtract Written"><span>Add & Subtract<br>Written</span></button>
                <button class="arcade-button mission-btn" data-cdr="C3" data-mission="Estimate & Inverse"><span>Estimate &<br>Inverse</span></button>
                <button class="arcade-button mission-btn" data-cdr="C4" data-mission="Add & Subtract Problems"><span>Add & Subtract<br>Problems</span></button>
                <button class="arcade-button mission-btn" data-cdr="C5" data-mission="Properties of Number"><span>Properties<br>of Number</span></button>
                <button class="arcade-button mission-btn" data-cdr="C6" data-mission="Mult & Div Mentally"><span>Mult & Div<br>Mentally</span></button>
                <button class="arcade-button mission-btn" data-cdr="C7" data-mission="Mult & Div Written"><span>Mult & Div<br>Written</span></button>
                <button class="arcade-button mission-btn" data-cdr="C8" data-mission="Solve Problems"><span>Solve<br>Problems</span></button>
                <button class="arcade-button mission-btn" data-cdr="C9" data-mission="Order of Operations"><span>Order of<br>Operations</span></button>
            </div>
        </div>

        <!-- 3. Fractions, Decimals and Percentages (12 Buttons - 4 Rows) -->
        <div id="worldFDPPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">FRACTIONS, DECIMALS & %</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="F1" data-mission="Recognise & Count Fractions"><span>Recognise &<br>Count<br>Fractions</span></button>
                <button class="arcade-button mission-btn" data-cdr="F2" data-mission="Equivalent Fractions"><span>Equivalent<br>Fractions</span></button>
                <button class="arcade-button mission-btn" data-cdr="F3" data-mission="Compare & Order"><span>Compare &<br>Order</span></button>
                <button class="arcade-button mission-btn" data-cdr="F4" data-mission="Add & Subtract Fractions"><span>Add & Subtract<br>Fractions</span></button>
                <button class="arcade-button mission-btn" data-cdr="F5" data-mission="Multiply & Divide"><span>Multiply &<br>Divide</span></button>
                <button class="arcade-button mission-btn" data-cdr="F6" data-mission="Fractions / Decimals Equiv."><span>Fractions /<br>Decimals<br>Equiv.</span></button>
                <button class="arcade-button mission-btn" data-cdr="F7" data-mission="Rounding Decimals"><span>Rounding<br>Decimals</span></button>
                <button class="arcade-button mission-btn" data-cdr="F8" data-mission="Compare Decimals"><span>Compare<br>Decimals</span></button>
                <button class="arcade-button mission-btn" data-cdr="F9" data-mission="Mult & Div Decimals"><span>Mult & Div<br>Decimals</span></button>
                <button class="arcade-button mission-btn" data-cdr="F10" data-mission="Fraction & Decimal Problems"><span>Fraction &<br>Decimal<br>Problems</span></button>
                <button class="arcade-button mission-btn" data-cdr="F11" data-mission="FDP Equivalence"><span class="compact-text">FDP<br>Equivalence</span></button>
                <button class="arcade-button mission-btn" data-cdr="F12" data-mission="Percentage Problems"><span>Percentage<br>Problems</span></button>
            </div>
        </div>

        <!-- 4. Ratio and Proportion (4 Buttons -> 6 Slots) -->
        <div id="worldRatioPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">RATIO & PROPORTION</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="R1" data-mission="Relative Sizes"><span>Relative<br>Sizes</span></button>
                <button class="arcade-button mission-btn" data-cdr="R2" data-mission="Percentage Comparison"><span>Percentage<br>Comparison</span></button>
                <button class="arcade-button mission-btn" data-cdr="R3" data-mission="Scale Factors"><span>Scale<br>Factors</span></button>
                <button class="arcade-button mission-btn" data-cdr="R4" data-mission="Unequal Sharing"><span>Unequal<br>Sharing</span></button>
                <!-- Blank Buttons for Padding -->
                <button class="arcade-button blank"></button>
                <button class="arcade-button blank"></button>
            </div>
        </div>

        <!-- 5. Algebra (5 Buttons -> 6 Slots) -->
        <div id="worldAlgebraPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">ALGEBRA</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="A1" data-mission="Missing Numbers"><span>Missing<br>Numbers</span></button>
                <button class="arcade-button mission-btn" data-cdr="A2" data-mission="Formulae"><span>Formulae</span></button>
                <button class="arcade-button mission-btn" data-cdr="A3" data-mission="Linear Sequences"><span>Linear<br>Sequences</span></button>
                <button class="arcade-button mission-btn" data-cdr="A4" data-mission="Two Unknowns"><span>Two<br>Unknowns</span></button>
                <button class="arcade-button mission-btn" data-cdr="A5" data-mission="Combinations of Variables"><span class="compact-text">Combinations<br>of<br>Variables</span></button>
                <!-- Blank Button for Padding -->
                <button class="arcade-button blank"></button>
            </div>
        </div>

        <!-- 6. Measurement (9 Buttons - 3 Rows) -->
        <div id="worldMeasurementPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">MEASUREMENT</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="M1" data-mission="Compare & Order"><span>Compare &<br>Order</span></button>
                <button class="arcade-button mission-btn" data-cdr="M2" data-mission="Estimate & Measure"><span>Estimate &<br>Measure</span></button>
                <button class="arcade-button mission-btn" data-cdr="M3" data-mission="Money"><span>Money</span></button>
                <button class="arcade-button mission-btn" data-cdr="M4" data-mission="Time"><span>Time</span></button>
                <button class="arcade-button mission-btn" data-cdr="M5" data-mission="Metric Conversion"><span>Metric<br>Conversion</span></button>
                <button class="arcade-button mission-btn" data-cdr="M6" data-mission="Metric / Imperial"><span>Metric /<br>Imperial</span></button>
                <button class="arcade-button mission-btn" data-cdr="M7" data-mission="Perimeter & Area"><span>Perimeter<br>& Area</span></button>
                <button class="arcade-button mission-btn" data-cdr="M8" data-mission="Volume"><span>Volume</span></button>
                <button class="arcade-button mission-btn" data-cdr="M9" data-mission="Measurement Problems"><span>Solve<br>Problems</span></button>
            </div>
        </div>

        <!-- 7. Geometry - Properties of Shapes (5 Buttons -> 6 Slots) -->
        <div id="worldShapesPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">PROPERTIES OF SHAPES</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="G1" data-mission="2D Shapes"><span>2D Shapes</span></button>
                <button class="arcade-button mission-btn" data-cdr="G2" data-mission="3D Shapes"><span>3D Shapes</span></button>
                <button class="arcade-button mission-btn" data-cdr="G3" data-mission="Lines & Angles"><span>Lines &<br>Angles</span></button>
                <button class="arcade-button mission-btn" data-cdr="G4" data-mission="Draw & Construct"><span>Draw &<br>Construct</span></button>
                <button class="arcade-button mission-btn" data-cdr="G5" data-mission="Circles"><span>Circles</span></button>
                <!-- Blank Button for Padding -->
                <button class="arcade-button blank"></button>
            </div>
        </div>

        <!-- 8. Geometry - Position and Direction (3 Buttons - 1 Row) -->
        <div id="worldPositionPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">POSITION & DIRECTION</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="P1" data-mission="Pattern & Symmetry"><span>Pattern &<br>Symmetry</span></button>
                <button class="arcade-button mission-btn" data-cdr="P2" data-mission="Position & Movement"><span class="compact-text">Position &<br>Movement</span></button>
                <button class="arcade-button mission-btn" data-cdr="P3" data-mission="Coordinates"><span>Coordinates</span></button>
            </div>
        </div>

        <!-- 9. Statistics (3 Buttons - 1 Row) -->
        <div id="worldStatisticsPage" class="page">
            <div class="breadcrumb-container"></div>
            <div class="title-area">
                <h1 class="title">STATISTICS</h1>
                <h2 class="subtitle">SELECT MISSION</h2>
            </div>
            <div class="arcade-button-container">
                <button class="arcade-button mission-btn" data-cdr="S1" data-mission="Tables & Timetables"><span>Tables &<br>Timetables</span></button>
                <button class="arcade-button mission-btn" data-cdr="S2" data-mission="Charts & Graphs"><span>Charts &<br>Graphs</span></button>
                <button class="arcade-button mission-btn" data-cdr="S3" data-mission="Mean Average"><span>Mean<br>Average</span></button>
            </div>
        </div>

    </div>

    <!-- User Authentication -->
    <script src="user-auth.js"></script>
    <script>
        function showWelcomeToast(user) {
            const toast = document.getElementById('welcomeToast');
            if (!toast) return;

            const firstName = user?.firstName || user?.first_name || 'Explorer';
            toast.textContent = `WELCOME, ${firstName.toUpperCase()}!`;
            toast.classList.add('show');

            setTimeout(() => toast.classList.remove('show'), 3200);
        }

        document.addEventListener('DOMContentLoaded', () => {
            let user = null;
            if (typeof UserAuth !== 'undefined') {
                user = UserAuth.requireLogin();
                if (!user) return;
                
                const headerContainer = document.getElementById('userHeaderContainer');
                const userHeader = UserAuth.createUserHeader();
                if (userHeader) {
                    headerContainer.appendChild(userHeader);
                }
            }

            if (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('showWelcomeToast') === '1') {
                sessionStorage.removeItem('showWelcomeToast');
                showWelcomeToast(user);
            }
        });
    </script>

    <script>
        // --- Page Logic ---
        const pages = {
            worldsPage: document.getElementById('worldsPage'),
            worldNumberPage: document.getElementById('worldNumberPage'),
            worldCalculationsPage: document.getElementById('worldCalculationsPage'),
            worldFDPPage: document.getElementById('worldFDPPage'),
            worldRatioPage: document.getElementById('worldRatioPage'),
            worldAlgebraPage: document.getElementById('worldAlgebraPage'),
            worldMeasurementPage: document.getElementById('worldMeasurementPage'),
            worldShapesPage: document.getElementById('worldShapesPage'),
            worldPositionPage: document.getElementById('worldPositionPage'),
            worldStatisticsPage: document.getElementById('worldStatisticsPage'),
        };

        const pageHierarchy = {
            'worldsPage': { parent: null, name: 'Worlds' },
            'worldNumberPage': { parent: 'worldsPage', name: 'Number' },
            'worldCalculationsPage': { parent: 'worldsPage', name: 'Calculations' },
            'worldFDPPage': { parent: 'worldsPage', name: 'Fractions' },
            'worldRatioPage': { parent: 'worldsPage', name: 'Ratio' },
            'worldAlgebraPage': { parent: 'worldsPage', name: 'Algebra' },
            'worldMeasurementPage': { parent: 'worldsPage', name: 'Measure' },
            'worldShapesPage': { parent: 'worldsPage', name: 'Shapes' },
            'worldPositionPage': { parent: 'worldsPage', name: 'Position' },
            'worldStatisticsPage': { parent: 'worldsPage', name: 'Statistics' },
        };

        let globalCurrentPageId = 'worldsPage';

        function showPage(pageId) {
            const pageElement = pages[pageId];
            Object.values(pages).forEach(p => { if (p) p.classList.remove('active'); });

            if (pageElement) {
                pageElement.classList.add('active');
                globalCurrentPageId = pageId;
                updateBreadcrumbs(pageId);
                applyButtonColors();
            }
        }

        function updateBreadcrumbs(pageId) {
            const pageElement = pages[pageId];
            if (!pageElement) return;
            const container = pageElement.querySelector('.breadcrumb-container');
            if (!container) return;

            // Inject Title on Main Page (PowerUp / Academy - centred)
            if (pageId === 'worldsPage') {
                container.innerHTML = '<div class="welcome-message">PowerUp<br>Academy</div>';
                container.style.justifyContent = 'center';
                return;
            }

            // Normal Breadcrumbs on subpages
            container.style.justifyContent = 'flex-start';
            container.innerHTML = '';
            let trail = [];
            let currentPageId = pageId;

            while (currentPageId) {
                const pageInfo = pageHierarchy[currentPageId];
                if (pageInfo) {
                    trail.unshift({ id: currentPageId, name: pageInfo.name });
                    currentPageId = pageInfo.parent;
                } else { break; }
            }
            if (trail.length > 0) trail.pop(); // Remove current page from buttons

            trail.forEach((crumb, index) => {
                if (index > 0) {
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '>';
                    container.appendChild(separator);
                }
                const button = document.createElement('button');
                button.className = 'breadcrumb-button';
                button.textContent = crumb.name;
                button.onclick = () => showPage(crumb.id);
                container.appendChild(button);
            });
        }

        function applyButtonColors() {
            const colors = ['#e53935', '#1e88e5', '#43a047', '#ffd600', '#ec407a', '#fafafa'];
            document.querySelectorAll('.page').forEach(page => {
                const buttons = page.querySelectorAll('.arcade-button');
                buttons.forEach((button, index) => {
                    const color = colors[index % colors.length];
                    button.style.setProperty('--arcade-btn-color', color);
                });
            });
        }

        // --- Mission Button Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const missionButtons = document.querySelectorAll('.mission-btn');
            
            missionButtons.forEach(btn => {
                if(btn.classList.contains('blank')) return; // Ignore blank buttons

                const cdr = btn.dataset.cdr;
                const mission = btn.dataset.mission;
                
                // All missions load Q_Server.html with CDR and mission params
                btn.addEventListener('click', () => {
                    window.location.href = `Q_Server.html?cdr=${encodeURIComponent(cdr)}&mission=${encodeURIComponent(mission)}&level=1`;
                });
            });
        });

        // Backspace Navigation
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Backspace' && globalCurrentPageId !== 'worldsPage') {
                event.preventDefault();
                showPage('worldsPage');
            }
        });

        // Initialize
        applyButtonColors();
        showPage('worldsPage');
    </script>
</body>
</html>